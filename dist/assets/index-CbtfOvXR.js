(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const s of n)if(s.type==="childList")for(const i of s.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&r(i)}).observe(document,{childList:!0,subtree:!0});function o(n){const s={};return n.integrity&&(s.integrity=n.integrity),n.referrerPolicy&&(s.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?s.credentials="include":n.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function r(n){if(n.ep)return;n.ep=!0;const s=o(n);fetch(n.href,s)}})();const a={baseUrl:"https://mesto.nomoreparties.co/v1/apf-cohort-202",headers:{authorization:"b8638112-8a37-4df1-a7b9-aa0862d793ab","Content-Type":"application/json"}},f=e=>e.ok?e.json():Promise.reject(`Ошибка: ${e.status}`),F=()=>fetch(`${a.baseUrl}/users/me`,{headers:a.headers}).then(f),M=()=>fetch(`${a.baseUrl}/cards`,{headers:a.headers}).then(f),X=({name:e,about:t})=>fetch(`${a.baseUrl}/users/me`,{method:"PATCH",headers:a.headers,body:JSON.stringify({name:e,about:t})}).then(f),Y=e=>fetch(`${a.baseUrl}/users/me/avatar`,{method:"PATCH",headers:a.headers,body:JSON.stringify({avatar:e})}).then(f),Z=({name:e,link:t})=>fetch(`${a.baseUrl}/cards`,{method:"POST",headers:a.headers,body:JSON.stringify({name:e,link:t})}).then(f),D=e=>fetch(`${a.baseUrl}/cards/${e}`,{method:"DELETE",headers:a.headers}).then(f),ee=(e,t)=>fetch(`${a.baseUrl}/cards/likes/${e}`,{method:t?"DELETE":"PUT",headers:a.headers}).then(f),te=()=>document.getElementById("card-template").content.querySelector(".card").cloneNode(!0),V=(e,{onPreviewPicture:t,onLikeIcon:o,onDeleteCard:r},n)=>{const s=te(),i=s.querySelector(".card__like-button"),c=s.querySelector(".card__control-button_type_delete"),l=s.querySelector(".card__image"),u=s.querySelector(".card__likes-count");l.src=e.link,l.alt=e.name,s.querySelector(".card__title").textContent=e.name,u&&e.likes&&(u.textContent=e.likes.length);const L=e.owner&&e.owner._id===n;return!L&&c&&(c.style.display="none"),e.likes&&e.likes.some(b=>b._id===n)&&i&&i.classList.add("card__like-button_is-active"),e._id&&(s.dataset.cardId=e._id),o&&i&&u&&i.addEventListener("click",()=>o(e._id,i,u)),r&&L&&c&&c.addEventListener("click",()=>r(e._id,s)),t&&l&&l.addEventListener("click",()=>t({name:e.name,link:e.link})),s},j=e=>{if(e.key==="Escape"){const t=document.querySelector(".popup_is-opened");_(t)}},y=e=>{e.classList.add("popup_is-opened"),document.addEventListener("keyup",j)},_=e=>{e.classList.remove("popup_is-opened"),document.removeEventListener("keyup",j)},oe=e=>{e.querySelector(".popup__close").addEventListener("click",()=>{_(e)}),e.addEventListener("mousedown",o=>{o.target.classList.contains("popup")&&_(e)})},ne=(e,t,o,r)=>{const n=e.querySelector(`#${t.id}-error`);t.classList.add(r.inputErrorClass),n.textContent=o,n.classList.add(r.errorClass)},H=(e,t,o)=>{const r=e.querySelector(`#${t.id}-error`);t.classList.remove(o.inputErrorClass),r.classList.remove(o.errorClass),r.textContent=""},re=(e,t,o)=>{t.validity.patternMismatch?t.setCustomValidity(t.dataset.errorMessage||""):t.setCustomValidity(""),t.validity.valid?H(e,t,o):ne(e,t,t.validationMessage,o)},se=e=>e.some(t=>!t.validity.valid),J=(e,t)=>{e.disabled=!0,e.classList.add(t.inactiveButtonClass)},ce=(e,t)=>{e.disabled=!1,e.classList.remove(t.inactiveButtonClass)},$=(e,t,o)=>{se(e)?J(t,o):ce(t,o)},le=(e,t)=>{const o=Array.from(e.querySelectorAll(t.inputSelector)),r=e.querySelector(t.submitButtonSelector);$(o,r,t),o.forEach(n=>{n.addEventListener("input",()=>{re(e,n,t),$(o,r,t)})})},ie=e=>{Array.from(document.querySelectorAll(e.formSelector)).forEach(o=>{o.addEventListener("submit",r=>{r.preventDefault()}),o.addEventListener("invalid",r=>{r.preventDefault()},!0),le(o,e)})},x=(e,t)=>{const o=Array.from(e.querySelectorAll(t.inputSelector)),r=e.querySelector(t.submitButtonSelector);o.forEach(n=>{H(e,n,t)}),J(r,t)},S={formSelector:".popup__form",inputSelector:".popup__input",submitButtonSelector:".popup__button",inactiveButtonClass:"popup__button_disabled",inputErrorClass:"popup__input_type_error",errorClass:"popup__error_visible"};ie(S);const z=document.querySelector(".places__list"),E=document.querySelector(".popup_type_edit"),T=document.querySelector(".popup_type_new-card"),I=document.querySelector(".popup_type_edit-avatar"),P=document.querySelector(".popup_type_image"),U=document.querySelector(".popup_type_remove-card"),m=document.querySelector(".popup_type_info"),h=E.querySelector(".popup__form"),K=h.querySelector(".popup__input_type_name"),R=h.querySelector(".popup__input_type_description"),p=T.querySelector(".popup__form"),ae=p.querySelector(".popup__input_type_card-name"),ue=p.querySelector(".popup__input_type_url"),v=I.querySelector(".popup__form"),de=v.querySelector(".popup__input"),O=U.querySelector(".popup__form"),N=P.querySelector(".popup__image"),pe=P.querySelector(".popup__caption"),B=document.querySelector(".profile__title"),A=document.querySelector(".profile__description"),w=document.querySelector(".profile__image");let k="",g=null,q=null;const d=(e,t,o,r)=>{t?(e.textContent=r,e.disabled=!0):(e.textContent=o,e.disabled=!1)},G=({name:e,link:t})=>{N.src=t,N.alt=e,pe.textContent=e,y(P)},Q=(e,t,o)=>{const r=t.classList.contains("card__like-button_is-active");ee(e,r).then(n=>{r?t.classList.remove("card__like-button_is-active"):t.classList.add("card__like-button_is-active"),o&&(o.textContent=n.likes.length)}).catch(n=>{console.log("Ошибка при изменении лайка:",n)})},W=(e,t)=>{g=e,q=t,y(U)},_e=e=>{const t=new Set;let o=0,r=0,n=null;const s={};e.forEach(c=>{c.owner&&c.owner._id&&t.add(c.owner._id),o+=c.likes.length,c.likes.forEach(l=>{t.add(l._id),s[l._id]||(s[l._id]={user:l,likesCount:0}),s[l._id].likesCount++,s[l._id].likesCount>r&&(r=s[l._id].likesCount,n=l)})});const i=[...e].sort((c,l)=>l.likes.length-c.likes.length).slice(0,3);return{totalUsers:t.size,totalLikes:o,maxLikesFromSingleUser:r,champion:n,popularCards:i}},fe=()=>{Promise.all([F(),M()]).then(([e,t])=>{const o=_e(t),r=m.querySelector(".popup__info-description_users"),n=m.querySelector(".popup__info-description_likes"),s=m.querySelector(".popup__info-description_max-likes"),i=m.querySelector(".popup__info-description_champion"),c=m.querySelector(".popup__cards-container");if(r&&(r.textContent=o.totalUsers),n&&(n.textContent=o.totalLikes),s&&(s.textContent=o.maxLikesFromSingleUser),i&&o.champion?i.textContent=o.champion.name||"Неизвестный пользователь":i&&(i.textContent="Нет чемпиона"),c){c.innerHTML="",c.style.display="inline";const l=document.getElementById("popular-card-template");if(o.popularCards.forEach((u,L)=>{const C=l.content.cloneNode(!0),b=C.querySelector(".popup__popular-card-text");b.textContent=u.name+"  ",c.appendChild(C)}),o.popularCards.length===0){const u=document.createElement("span");u.classList.add("popup__popular-card-text"),u.textContent="Нет популярных карточек",c.appendChild(u)}}y(m)}).catch(e=>{console.log("Ошибка при загрузке статистики:",e)})};h.addEventListener("submit",e=>{e.preventDefault();const t=h.querySelector(".popup__button"),o=t.dataset.defaultText||"Сохранить",r=t.dataset.loadingText||"Сохранение...";d(t,!0,o,r),X({name:K.value,about:R.value}).then(n=>{B.textContent=n.name,A.textContent=n.about,_(E)}).catch(n=>{console.log(n)}).finally(()=>{d(t,!1,o,r)})});v.addEventListener("submit",e=>{e.preventDefault();const t=v.querySelector(".popup__button"),o=t.dataset.defaultText||"Сохранить",r=t.dataset.loadingText||"Сохранение...";d(t,!0,o,r),Y(de.value).then(n=>{w.style.backgroundImage=`url(${n.avatar})`,_(I)}).catch(n=>{console.log(n)}).finally(()=>{d(t,!1,o,r)})});p.addEventListener("submit",e=>{e.preventDefault();const t=p.querySelector(".popup__button"),o=t.dataset.defaultText||"Создать",r=t.dataset.loadingText||"Создание...";d(t,!0,o,r),Z({name:ae.value,link:ue.value}).then(n=>{const s=V(n,{onPreviewPicture:G,onLikeIcon:Q,onDeleteCard:W},k);z.prepend(s),p.reset(),_(T)}).catch(n=>{console.log(n)}).finally(()=>{d(t,!1,o,r)})});O.addEventListener("submit",e=>{e.preventDefault();const t=O.querySelector(".popup__button"),o=t.dataset.defaultText||"Да",r=t.dataset.loadingText||"Удаление...";d(t,!0,o,r),D(g).then(()=>{q.remove(),_(U)}).catch(n=>{console.log("Ошибка при удалении:",n)}).finally(()=>{d(t,!1,o,r),g=null,q=null})});document.querySelector(".profile__edit-button").addEventListener("click",()=>{K.value=B.textContent,R.value=A.textContent,x(h,S),y(E)});document.querySelector(".profile__add-button").addEventListener("click",()=>{p.reset(),x(p,S),y(T)});w.addEventListener("click",()=>{v.reset(),x(v,S),y(I)});document.querySelector(".header__logo").addEventListener("click",fe);Promise.all([M(),F()]).then(([e,t])=>{k=t._id,B.textContent=t.name,A.textContent=t.about,w.style.backgroundImage=`url(${t.avatar})`,e.forEach(o=>{z.append(V(o,{onPreviewPicture:G,onLikeIcon:Q,onDeleteCard:W},k))})}).catch(e=>{console.log("Ошибка при загрузке данных:",e)});document.querySelectorAll(".popup").forEach(e=>{oe(e)});
